{# templates/column_chart.html — partial #}

<div class="card">
  <div class="card-body">
    <h3 class="card-title">График по колонке</h3>

    <!-- Загрузка файла -->
    <form method="post" enctype="multipart/form-data" action="{% url 'postfile' %}">
      {% csrf_token %}
      <input type="hidden" name="next_partial" value="column_chart.html">
      <div class="mb-3">
        <label class="form-label">Загрузите CSV-файл</label>
        <div class="input-group">
          <input class="form-control" type="file" name="file" required>
          <button class="btn btn-success" type="submit">Загрузить</button>
        </div>
      </div>
    </form>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}

    {% if show_preview %}
      <h5 class="mt-3">Предпросмотр данных</h5>
      <div class="mb-2">
        <button class="btn btn-outline-primary btn-sm" type="button" onclick="togglePreview()">Показать/Скрыть таблицу</button>
      </div>
      <div id="preview-container" class="table-responsive mb-3" style="max-height: 300px; overflow:auto;">
        <table class="table table-bordered table-sm">
          <thead class="table-light">
            <tr>
              <th><input type="checkbox" id="select-all" title="Выбрать все колонки"></th>
              {% for col in columns %}
                <th>{{ col }}</th>
              {% endfor %}
            </tr>
          </thead>
          <tbody>
            {% for row in rows %}
              <tr>
                <td></td>
                {% for cell in row %}
                  <td>{{ cell }}</td>
                {% endfor %}
              </tr>
            {% endfor %}
            <tr><td colspan="{{ columns|length|add:'1' }}" class="text-center text-muted">…</td></tr>
          </tbody>
        </table>
      </div>
    {% endif %}

    
    <form method="post" action="{% url 'run_analysis' %}">
      {% csrf_token %}
      <input type="hidden" name="analysis_type" value="column_chart">

      <div class="mb-3">
        <label class="form-label">Выберите колонки (галочками)</label>
        <div class="row">
          {% for col in columns %}
            <div class="col-6 col-md-4">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="columns" value="{{ col }}" id="col_{{ forloop.counter }}">
                <label class="form-check-label" for="col_{{ forloop.counter }}">{{ col }}</label>
              </div>
            </div>
          {% empty %}
            <div class="col-12 text-muted">Нет загруженных колонок</div>
          {% endfor %}
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Тип графика</label>
        <select name="plot_type" class="form-select">
          <option value="hist">Гистограмма</option>
          <option value="line">Линейный график</option>
          <option value="box">Boxplot</option>
        </select>
      </div>

      <button type="submit" class="btn btn-primary">Построить</button>
      <a href="{% url 'clear_upload' %}" class="btn btn-secondary ms-2">Назад</a>

    </form>

    {% if result %}
      <div class="mt-4">
        <h5>Результат</h5>
        {{ result|safe }}
      </div>
    {% endif %}

    {% if plot %}
      <div class="mt-4">
        <h5>График</h5>
        <img src="data:image/png;base64,{{ plot }}" class="img-fluid" alt="plot">
        <div class="mt-2"> 
            <a href="data:image/png;base64,{{ plot }}" download="plot.png" class="btn btn-success">Скачать PNG</a> 
        </div>
      </div>
    {% endif %}
  </div>
</div>

<script>
  function togglePreview() {
    const el = document.getElementById('preview-container');
    if (el) el.classList.toggle('d-none');
  }
  document.addEventListener('DOMContentLoaded', function(){
    const selectAll = document.getElementById('select-all');
    if (!selectAll) return;
    selectAll.addEventListener('change', function(){
      const checked = this.checked;
      document.querySelectorAll('input[name="columns"]').forEach(cb => cb.checked = checked);
    });
  });
</script>
